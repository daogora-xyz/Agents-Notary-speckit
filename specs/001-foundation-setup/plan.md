# Implementation Plan: Project Foundation Infrastructure

**Branch**: `001-foundation-setup` | **Date**: 2025-10-28 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-foundation-setup/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command based on the feature specification and constitution requirements.

## Summary

Establish the foundational infrastructure for the blockchain certification platform by creating a reproducible development environment with PostgreSQL database (versioned migrations), Redis caching layer (with graceful degradation), and shared Go packages for data models, cryptographic utilities (Secp256k1), and error handling. This foundation enables all future feature development with consistent data structures, reliable persistence, and development environment parity.

**Primary Requirement**: Developers can initialize a complete local development environment with a single command, with all services running, database schemas migrated, and shared packages available for import.

**Technical Approach**: Docker Compose orchestrates PostgreSQL 16 and Redis 7 services. golang-migrate handles database migrations with strict failure-blocks-startup policy. Shared Go modules in `pkg/` provide reusable models, crypto utilities (using btcsuite/btcd for Secp256k1), and typed error hierarchies.

## Technical Context

**Language/Version**: Go 1.23+
**Primary Dependencies**:
- golang-migrate/migrate (database migrations)
- lib/pq or pgx (PostgreSQL driver)
- go-redis/redis (Redis client with graceful fallback)
- btcsuite/btcd/btcec/v2 (Secp256k1 cryptography for Circular Protocol Enterprise APIs compatibility)
- Docker Compose (service orchestration)

**Storage**: PostgreSQL 16+ with connection pooling (max 50 connections), Redis 7+ with allkeys-lru eviction policy
**Testing**: Go testing framework with testify/assert, dockertest for integration tests
**Target Platform**: Linux/macOS development environments (Docker Desktop), Windows via WSL2
**Project Type**: Monorepo with shared packages - establishes foundation for future MCP servers and proxy services
**Performance Goals**:
- Environment initialization < 5 minutes
- Cache operations < 10ms P95
- Database supports 50 concurrent connections
- Crypto signing < 100ms per operation

**Constraints**:
- Failed migrations MUST block startup (no graceful degradation)
- Cache unavailability MUST NOT block startup (graceful degradation)
- All configuration via environment variables for secrets
- Minimum 8GB RAM, 10GB disk space

**Scale/Scope**: Foundation for 10+ subsequent milestones, 4 MCP servers + 1 proxy service, ~15 database tables total (4 in this milestone)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Principle I: Specification-Driven Development ✅ PASS
- ✅ Feature specification complete in spec.md
- ✅ User stories prioritized (P1-P3) and independently testable
- ✅ This plan follows `/speckit.specify` → `/speckit.clarify` → `/speckit.plan` workflow

### Principle II: Test-First Development (NON-NEGOTIABLE) ✅ PASS
- ✅ Plan will generate test requirements in tasks.md phase
- ✅ Integration tests required for: database migrations, cache operations, shared package imports
- ✅ Unit tests required for: data model validation, crypto signing/verification, error wrapping
- ✅ Coverage target: 80% minimum (foundation code)
- ⚠️  Note: This is infrastructure setup, so TDD applies to validation scripts and setup code

### Principle III: MCP Architecture ✅ PASS (N/A for foundation)
- ✅ This milestone establishes foundation, MCP servers built in subsequent milestones
- ✅ Shared models prepared for future MCP tool parameter validation

### Principle IV: Security-First Design ✅ PASS
- ✅ Crypto utilities use industry-standard Secp256k1 (btcsuite/btcd)
- ✅ No wallet keys stored in this milestone (prepared for future encrypted storage)
- ✅ SQL injection resistance via parameterized queries (lib/pq or pgx)
- ✅ Environment variable-based configuration (no secrets in code)

### Principle V: Observability & Monitoring ⚠️ DEFERRED TO MILESTONE 8
- ⚠️  Structured logging (Zap) deferred to Milestone 8 (Monitoring & Operations)
- ⚠️  Prometheus metrics deferred to Milestone 8
- ✅ Foundation includes error types for future logging categorization

### Principle VI: Blockchain Integration Standards ✅ PASS
- ✅ Secp256k1 crypto utilities match Circular Protocol Enterprise APIs signing requirements
- ✅ Data models prepared for Circular Protocol Enterprise API transaction fields (cirx_tx_id, cirx_block_id)
- ✅ Payment nonce uniqueness enforced at database level

**Overall Status**: ✅ PASS - No constitution violations. Observability deferred appropriately to Milestone 8.

## Project Structure

### Documentation (this feature)

```text
specs/001-foundation-setup/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Technology selection research
├── data-model.md        # Database schema details
├── quickstart.md        # Developer setup guide
└── checklists/
    └── requirements.md  # Specification quality checklist
```

### Source Code (repository root)

```text
# Go monorepo structure (based on docs/OVERVIEW.md Section 3.1)

# Root-level configuration
docker-compose.yml       # PostgreSQL + Redis service definitions
.env.example             # Environment variable template
Makefile                 # Common development tasks
go.mod                   # Go module definition
go.sum                   # Dependency checksums

# Database migrations
migrations/
├── 001_init.up.sql      # Create all 4 tables + indexes + constraints
└── 001_init.down.sql    # Rollback migration

# Shared packages
pkg/
├── models/
│   ├── request.go       # CertificationRequest model + validation
│   ├── payment.go       # Payment model + validation
│   ├── certification.go # Certification model + validation
│   └── wallet.go        # WalletBalance model + validation
├── crypto/
│   ├── secp256k1.go     # Circular Protocol Enterprise APIs signing utilities
│   └── secp256k1_test.go
└── errors/
    ├── types.go         # Custom error types (Validation, Network, Blockchain, Payment)
    └── types_test.go

# Testing infrastructure
tests/
├── integration/
│   ├── docker-compose.test.yml  # Test database/cache instances
│   ├── migration_test.go        # Migration success/rollback tests
│   ├── cache_test.go            # Redis operations + graceful degradation tests
│   └── models_test.go           # Cross-service serialization tests
└── unit/
    └── (unit tests colocated with packages: pkg/*/

*_test.go)

# Development scripts
scripts/
├── setup-dev.sh         # Initialize development environment
└── migrate.sh           # Run migrations (wraps golang-migrate)

# Documentation
docs/
└── OVERVIEW.md          # System specification (already exists)

README.md                # Project README (update with setup instructions)
```

**Structure Decision**: This is a Go monorepo following standard Go project layout. The `pkg/` directory contains shared packages that will be imported by all 4 future MCP servers and the proxy service. Database migrations are centralized in `migrations/` directory. Docker Compose manages local development services (PostgreSQL, Redis).

## Complexity Tracking

> **No constitution violations detected - this section intentionally left empty**

---

## Phase 0: Research Findings

See [research.md](./research.md) for detailed technology selection rationale.

**Key Decisions**:
1. **Migration Framework**: golang-migrate/migrate - Industry standard, supports PostgreSQL and rollbacks, CLI + Go library
2. **PostgreSQL Driver**: pgx - Modern, high-performance, supports connection pooling, better error handling than lib/pq
3. **Redis Client**: go-redis/redis - Most popular Go Redis client, supports graceful connection handling
4. **Secp256k1 Library**: btcsuite/btcd/btcec/v2 - Bitcoin-grade cryptography, well-tested, compatible with Circular Protocol Enterprise APIs
5. **Testing**: testify/assert + dockertest - Standard Go testing with Docker container lifecycle management

---

## Phase 1: Design Artifacts

### Data Model
See [data-model.md](./data-model.md) for complete database schema, entity relationships, and validation rules.

### Quickstart Guide
See [quickstart.md](./quickstart.md) for step-by-step developer environment setup instructions.

### Contracts
No API contracts for this milestone - foundation infrastructure only. Future milestones will generate OpenAPI/MCP tool schemas in `/contracts/` directory.

---

## Implementation Notes

### Migration Failure Handling
Per clarification session 2025-10-28: Failed migrations MUST block environment startup entirely. Implementation approach:
- `docker-compose.yml` includes a health check that verifies migrations succeeded
- Proxy service startup script checks migration table for completion before launching
- Clear error messages include: failed migration file name, SQL error details, manual fix instructions

### Cache Graceful Degradation
Per clarification session 2025-10-28: Redis unavailability MUST NOT block startup. Implementation approach:
- Shared cache package includes `fallbackEnabled bool` flag
- All cache operations wrapped in error handling: `value, err := cache.Get(key); if err != nil { /* fetch directly */ }`
- Warning logged once on first cache failure: "Redis unavailable, operating without cache"

### Redis Eviction Policy
Per clarification session 2025-10-28: Configure `allkeys-lru` eviction policy. Implementation:
- Set in `docker-compose.yml` via `redis.conf` or command: `redis-server --maxmemory-policy allkeys-lru`
- Ensures frequently accessed CIRX price data stays in memory during high load

### Concurrent Migration Prevention
Standard golang-migrate behavior: Uses advisory locks in PostgreSQL to prevent concurrent migration attempts. No additional implementation needed.

### Shared Package Versioning
For breaking changes in shared packages:
- Semantic versioning in `go.mod` (v1.x.x, v2.x.x)
- Breaking changes require major version bump
- All dependent services update imports: `import "github.com/org/project/v2/pkg/models"`
- Documented in `CHANGELOG.md` with migration guide

---

## Next Steps

After this plan is reviewed and approved:

1. Run `/speckit.tasks` to generate `tasks.md` with TDD-ordered implementation tasks
2. Run `/speckit.implement` to execute tasks with test-first enforcement
3. Milestone completion gates:
   - ✅ All database tables created via migrations
   - ✅ Docker Compose starts all services successfully
   - ✅ Shared packages importable without errors
   - ✅ Integration tests pass (migrations, cache, models)
   - ✅ Documentation complete (README updated, quickstart tested)
